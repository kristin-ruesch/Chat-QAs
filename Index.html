<!DOCTYPE html>
<html>
<head>
    <title>Chat Quality Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { font-family: system-ui, sans-serif; line-height: 1.5 }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0 }
        .card { padding: 20px; border: 1px solid #ddd; border-radius: 8px }
        .red-flag { color: #dc3545; background: #fff5f5; padding: 10px; margin: 5px 0 }
        table { width: 100%; border-collapse: collapse }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd }
        input[type="file"] { margin: 20px 0 }
        button { padding: 8px 16px; margin: 5px; cursor: pointer }
        .chart-container { height: 300px; margin: 20px 0 }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chat Quality Analyzer</h1>
        
        <input type="file" id="csvFile" accept=".csv" multiple>
        
        <div class="stats">
            <div class="card">
                <h3>Total Chats</h3>
                <div id="totalChats">0</div>
            </div>
            <div class="card">
                <h3>Red Flags Detected</h3>
                <div id="redFlagsCount">0</div>
            </div>
            <div class="card">
                <h3>Accuracy Rate</h3>
                <div id="accuracyRate">100%</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>

        <div id="results"></div>
    </div>

<script>
let chats = [];
let feedbackStore = JSON.parse(localStorage.getItem('feedback') || '[]');

document.getElementById('csvFile').addEventListener('change', function(e) {
    Papa.parse(e.target.files[0], {
        header: true,
        complete: function(results) {
            processData(results.data);
        }
    });
});

function processData(rawData) {
    chats = rawData.map(chat => ({
        chatId: chat['Chat Id'],
        agent: chat['Agent Name'],
        email: chat['Email'],
        messages: parseMessages(chat['Messages']),
        redFlags: detectRedFlags(chat['Messages']),
        feedback: null
    }));

    updateDashboard();
    renderResults();
}

function parseMessages(raw) {
    return raw.split('\n').map(line => {
        const [timestamp, ...message] = line.trim().split(/ : /);
        return {
            timestamp: new Date(timestamp),
            sender: message[0].includes('Customer') ? 'Customer' : 'Agent',
            text: message.slice(1).join(' : ')
        };
    });
}

function detectRedFlags(messages) {
    const flags = [];
    let lastCustomerTime = null;

    // Response time check
    messages.forEach(msg => {
        if (msg.sender === 'Customer') {
            lastCustomerTime = msg.timestamp;
        } else if (msg.sender === 'Agent' && lastCustomerTime) {
            const diff = (msg.timestamp - lastCustomerTime) / 60000;
            if (diff > 5) flags.push("Delayed Response (>5 mins)");
            lastCustomerTime = null;
        }
    });

    // Refund check
    const refundKeywords = ['refund', 'credit', 'money back'];
    const customerRequested = messages.some(m => 
        m.sender === 'Customer' && 
        refundKeywords.some(kw => m.text.toLowerCase().includes(kw))
    );
    
    if (customerRequested && !messages.some(m => 
        m.sender === 'Agent' && m.text.toLowerCase().includes('refund')
    )) {
        flags.push("No Refund Offered");
    }

    // TNR check
    if (messages.some(m => 
        m.sender === 'Agent' && 
        m.text.toLowerCase().includes('tnr')
    )) {
        flags.push("Used TNR Script");
    }

    return flags;
}

function updateDashboard() {
    document.getElementById('totalChats').textContent = chats.length;
    document.getElementById('redFlagsCount').textContent = 
        chats.filter(c => c.redFlags.length > 0).length;
    
    // Update chart
    updateTrendChart();
}

function renderResults() {
    const container = document.getElementById('results');
    container.innerHTML = `
        <h2>Flagged Chats (${chats.filter(c => c.redFlags.length > 0).length})</h2>
        <table>
            <tr><th>Chat ID</th><th>Agent</th><th>Flags</th><th>Action</th></tr>
            ${chats.filter(c => c.redFlags.length > 0).map(chat => `
                <tr>
                    <td>${chat.chatId}</td>
                    <td>${chat.agent}</td>
                    <td>${chat.redFlags.join(', ')}</td>
                    <td>
                        <button onclick="markAccurate('${chat.chatId}')">Accurate</button>
                        <button onclick="markInaccurate('${chat.chatId}')">Inaccurate</button>
                    </td>
                </tr>
            `).join('')}
        </table>
    `;
}

function markAccurate(chatId) {
    saveFeedback(chatId, true);
    updateAccuracy();
}

function markInaccurate(chatId) {
    const comment = prompt('Enter reason:');
    saveFeedback(chatId, false, comment);
    updateAccuracy();
}

function saveFeedback(chatId, accurate, comment = '') {
    feedbackStore.push({
        chatId,
        accurate,
        comment,
        timestamp: new Date().toISOString()
    });
    localStorage.setItem('feedback', JSON.stringify(feedbackStore));
}

function updateAccuracy() {
    const totalFeedback = feedbackStore.length;
    if (totalFeedback === 0) return;
    
    const accurate = feedbackStore.filter(f => f.accurate).length;
    const rate = Math.round((accurate / totalFeedback) * 100);
    document.getElementById('accuracyRate').textContent = `${rate}%`;
}

function updateTrendChart() {
    const ctx = document.getElementById('trendChart').getContext('2d');
    const weeklyData = getWeeklyStats();
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: weeklyData.map(d => d.week),
            datasets: [{
                label: 'Red Flags',
                data: weeklyData.map(d => d.flags),
                borderColor: '#dc3545',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function getWeeklyStats() {
    // Simplified weekly aggregation
    return Array.from({length: 4}, (_, i) => ({
        week: `Week ${i+1}`,
        flags: Math.floor(Math.random() * 50)
    }));
}

// Initial render
document.getElementById('totalChats').textContent = 0;
</script>
</body>
</html>