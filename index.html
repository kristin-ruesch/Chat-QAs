<!DOCTYPE html>
<html>
<head>
    <title>Chat Quality Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { font-family: system-ui, sans-serif; line-height: 1.5 }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0 }
        .card { padding: 20px; border: 1px solid #ddd; border-radius: 8px }
        .red-flag { color: #dc3545; background: #fff5f5; padding: 10px; margin: 5px 0 }
        table { width: 100%; border-collapse: collapse }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd }
        input[type="file"] { margin: 20px 0 }
        button { padding: 8px 16px; margin: 5px; cursor: pointer }
        .chart-container { height: 300px; margin: 20px 0 }
        .hidden { display: none }
        .review-panel { border: 1px solid #ddd; padding: 20px; margin-top: 20px }
        .message-agent { color: #0d6efd }
        .message-customer { color: #198754 }
        .tab { margin: 20px 0; border-bottom: 1px solid #ddd }
        .tab button { padding: 10px 20px; border: none; background: #f8f9fa }
        .tab button.active { background: #e9ecef; border-bottom: 2px solid #0d6efd }
        .tabcontent { display: none; padding: 20px 0 }
        .tabcontent.active { display: block }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chat Quality Analyzer</h1>
        
        <input type="file" id="csvFile" accept=".csv" multiple>
        
        <div class="stats">
            <div class="card">
                <h3>Total Chats</h3>
                <div id="totalChats">0</div>
            </div>
            <div class="card">
                <h3>Red Flags</h3>
                <div id="redFlagsCount">0</div>
            </div>
            <div class="card">
                <h3>Rebill Scripts</h3>
                <div id="rebillCount">0</div>
            </div>
            <div class="card">
                <h3>TNR Scripts</h3>
                <div id="tnrCount">0</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>

        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'flagged')">Flagged Chats</button>
            <button class="tablinks" onclick="openTab(event, 'correct')">Correct Chats</button>
            <button class="tablinks" onclick="openTab(event, 'download')">Download Reports</button>
        </div>

        <div id="flagged" class="tabcontent active">
            <h2>Flagged Chats</h2>
            <div id="flaggedChatsList"></div>
        </div>

        <div id="correct" class="tabcontent">
            <h2>Correctly Flagged Chats</h2>
            <div id="correctChatsList"></div>
        </div>

        <div id="download" class="tabcontent">
            <h2>Download Reports</h2>
            <button onclick="downloadReport('rebill')">Download Rebill Chats</button>
            <button onclick="downloadReport('tnr')">Download TNR Chats</button>
        </div>

        <div id="reviewPanel" class="review-panel hidden">
            <h3>Chat Review</h3>
            <div id="chatDetails"></div>
            <div id="messageList"></div>
            <div style="margin-top: 20px">
                <button onclick="submitFeedback(true)">Accurate</button>
                <button onclick="submitFeedback(false)">Inaccurate</button>
                <input type="text" id="feedbackComment" placeholder="Add comment">
            </div>
        </div>
    </div>

<script>
let chats = [];
let feedbackStore = JSON.parse(localStorage.getItem('feedback') || '[]');
let currentChat = null;

document.getElementById('csvFile').addEventListener('change', function(e) {
    Papa.parse(e.target.files[0], {
        header: true,
        complete: function(results) {
            processData(results.data);
        }
    });
});

function processData(rawData) {
    chats = rawData.map(chat => {
        const messages = parseMessages(chat['Messages']);
        return {
            chatId: chat['Chat Id'],
            agent: chat['Agent Name'],
            email: chat['Email'],
            date: chat['Date'] || new Date().toISOString().split('T')[0], // Add date field if available
            messages,
            redFlags: detectRedFlags(messages),
            feedback: null
        };
    });

    // Count script usage
    const scriptCounts = {
        rebill: 0,
        tnr: 0
    };

    chats.forEach(chat => {
        if (chat.messages.some(m => 
            m.sender === 'Agent' && 
            m.text.toLowerCase().includes('rebill')
        )) scriptCounts.rebill++;
        
        if (chat.messages.some(m => 
            m.sender === 'Agent' && 
            m.text.toLowerCase().includes('tnr')
        )) scriptCounts.tnr++;
    });

    updateDashboard(scriptCounts);
    renderResults();
}

function parseMessages(raw) {
    return raw.split('\n').map(line => {
        const [timestamp, ...message] = line.trim().split(/ : /);
        return {
            timestamp: new Date(timestamp),
            sender: message[0].includes('Customer') ? 'Customer' : 'Agent',
            text: message.slice(1).join(' : ')
        };
    });
}

function detectRedFlags(messages) {
    const flags = [];
    let lastCustomerTime = null;

    // Response time check
    messages.forEach(msg => {
        if (msg.sender === 'Customer') {
            lastCustomerTime = msg.timestamp;
        } else if (msg.sender === 'Agent' && lastCustomerTime) {
            const diff = (msg.timestamp - lastCustomerTime) / 60000;
            if (diff > 5) flags.push("Delayed Response (>5 mins)");
            lastCustomerTime = null;
        }
    });

    // Refund check
    const refundKeywords = ['refund', 'credit', 'money back'];
    const customerRequested = messages.some(m => 
        m.sender === 'Customer' && 
        refundKeywords.some(kw => m.text.toLowerCase().includes(kw))
    );
    
    if (customerRequested && !messages.some(m => 
        m.sender === 'Agent' && m.text.toLowerCase().includes('refund')
    )) {
        flags.push("No Refund Offered");
    }

    // TNR check
    if (messages.some(m => 
        m.sender === 'Agent' && 
        m.text.toLowerCase().includes('tnr')
    )) {
        flags.push("Used TNR Script");
    }

    // Rebill check
    if (messages.some(m => 
        m.sender === 'Agent' && 
        m.text.toLowerCase().includes('rebill')
    )) {
        flags.push("Used Rebill Script");
    }

    return flags;
}

function updateDashboard(scriptCounts) {
    document.getElementById('totalChats').textContent = chats.length;
    const flaggedCount = chats.filter(c => c.redFlags.length > 0).length;
    document.getElementById('redFlagsCount').textContent = flaggedCount;
    document.getElementById('rebillCount').textContent = scriptCounts.rebill;
    document.getElementById('tnrCount').textContent = scriptCounts.tnr;
    
    // Update chart
    updateTrendChart();
}

function renderResults() {
    const container = document.getElementById('flaggedChatsList');
    
    const flaggedChats = chats.filter(c => c.redFlags.length > 0);
    
    if (flaggedChats.length === 0) {
        container.innerHTML = '<p>No red flags detected</p>';
        return;
    }

    container.innerHTML = `
        <table>
            <tr>
                <th>Chat ID</th>
                <th>Agent</th>
                <th>Flags</th>
                <th>Action</th>
            </tr>
            ${flaggedChats.map(chat => `
                <tr>
                    <td>${chat.chatId}</td>
                    <td>${chat.agent}</td>
                    <td>${chat.redFlags.join(', ')}</td>
                    <td>
                        <button onclick="showReview('${chat.chatId}')">Review</button>
                    </td>
                </tr>
            `).join('')}
        </table>
    `;
}

function showReview(chatId) {
    currentChat = chats.find(c => c.chatId === chatId);
    document.getElementById('reviewPanel').classList.remove('hidden');
    
    // Show chat details
    document.getElementById('chatDetails').innerHTML = `
        <p><strong>Chat ID:</strong> ${currentChat.chatId}</p>
        <p><strong>Agent:</strong> ${currentChat.agent}</p>
        <p><strong>Email:</strong> ${currentChat.email}</p>
        <p><strong>Date:</strong> ${currentChat.date}</p>
        <p><strong>Flags:</strong> ${currentChat.redFlags.join(', ')}</p>
    `;
    
    // Show messages
    document.getElementById('messageList').innerHTML = `
        <h4>Messages</h4>
        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px">
            ${currentChat.messages.map(msg => `
                <div class="${msg.sender === 'Agent' ? 'message-agent' : 'message-customer'}" style="margin: 5px 0">
                    <strong>${msg.sender}:</strong> ${msg.text}
                </div>
            `).join('')}
        </div>
    `;
}

function submitFeedback(isAccurate) {
    const comment = document.getElementById('feedbackComment').value;
    saveFeedback(currentChat.chatId, isAccurate, comment);
    
    // Update correct chats list
    if (isAccurate) {
        renderCorrectChats();
    }
    
    updateAccuracyMetrics();
    alert('Feedback saved!');
}

function saveFeedback(chatId, accurate, comment = '') {
    const existing = feedbackStore.find(f => f.chatId === chatId);
    if (existing) {
        existing.accurate = accurate;
        existing.comment = comment;
    } else {
        feedbackStore.push({
            chatId,
            accurate,
            comment,
            timestamp: new Date().toISOString()
        });
    }
    localStorage.setItem('feedback', JSON.stringify(feedbackStore));
}

function renderCorrectChats() {
    const correctChats = chats.filter(chat => 
        feedbackStore.some(f => 
            f.chatId === chat.chatId && 
            f.accurate === true
        )
    );
    
    document.getElementById('correctChatsList').innerHTML = `
        <table>
            <tr>
                <th>Chat ID</th>
                <th>Agent</th>
                <th>Date</th>
                <th>Red Flags</th>
            </tr>
            ${correctChats.map(chat => `
                <tr>
                    <td>${chat.chatId}</td>
                    <td>${chat.agent}</td>
                    <td>${chat.date}</td>
                    <td>${chat.redFlags.join(', ')}</td>
                </tr>
            `).join('')}
        </table>
    `;
}

function updateAccuracyMetrics() {
    const totalFeedback = feedbackStore.length;
    if (totalFeedback === 0) return;
    
    const accurate = feedbackStore.filter(f => f.accurate).length;
    const rate = Math.round((accurate / totalFeedback) * 100);
    document.getElementById('accuracyRate').textContent = `${rate}%`;
}

function updateTrendChart() {
    // Chart implementation remains the same
}

function downloadReport(type) {
    let data;
    if (type === 'rebill') {
        data = chats.filter(chat => 
            chat.messages.some(m => 
                m.sender === 'Agent' && 
                m.text.toLowerCase().includes('rebill')
            )
        );
    } else {
        data = chats.filter(chat => 
            chat.messages.some(m => 
                m.sender === 'Agent' && 
                m.text.toLowerCase().includes('tnr')
            )
        );
    }
    
    const csvContent = `Chat ID,Agent,Date\n${data.map(chat => 
        `${chat.chatId},${chat.agent},${chat.date}`
    ).join('\n')}`;
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${type}_chats.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function openTab(evt, tabName) {
    // Tab switching logic
    document.querySelectorAll('.tabcontent').forEach(content => 
        content.classList.remove('active')
    );
    document.querySelectorAll('.tablinks').forEach(button => 
        button.classList.remove('active')
    );
    
    document.getElementById(tabName).classList.add('active');
    evt.currentTarget.classList.add('active');
}

// Initial render
document.getElementById('totalChats').textContent = 0;
</script>
</body>
</html>
