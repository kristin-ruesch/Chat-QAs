<!DOCTYPE html>
<html>
<head>
    <title>Chat Quality Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { font-family: system-ui, sans-serif; line-height: 1.5 }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0 }
        .card { padding: 20px; border: 1px solid #ddd; border-radius: 8px; text-align: center }
        .red-flag { color: #dc3545; background: #fff5f5; padding: 10px; margin: 5px 0 }
        table { width: 100%; border-collapse: collapse }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd }
        input[type="file"] { margin: 20px 0 }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px }
        .chart-container { height: 300px; margin: 20px 0 }
        .hidden { display: none }
        .review-panel { border: 1px solid #ddd; padding: 20px; margin-top: 20px }
        .message-agent { color: #0d6efd }
        .message-customer { color: #198754 }
        .analyze-btn { background: #28a745; font-size: 1.2em; padding: 15px 30px }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chat Quality Analyzer</h1>
        
        <input type="file" id="csvFile" accept=".csv" multiple>
        <button onclick="analyzeChats()" class="analyze-btn">Analyze Chats</button>
        
        <div class="stats">
            <div class="card">
                <h3>Total Chats</h3>
                <div id="totalChats">0</div>
            </div>
            <div class="card">
                <h3>Red Flags</h3>
                <div id="redFlagsCount">0</div>
            </div>
            <div class="card">
                <h3>Rebill Scripts</h3>
                <div id="rebillCount">0</div>
            </div>
            <div class="card">
                <h3>TNR Scripts</h3>
                <div id="tnrCount">0</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>

        <div id="results">
            <h2>Flagged Chats</h2>
            <div id="flaggedChatsList"></div>
        </div>

        <div id="reviewPanel" class="review-panel hidden">
            <h3>Chat Review</h3>
            <div id="chatDetails"></div>
            <div id="messageList"></div>
            <div style="margin-top: 20px">
                <button onclick="submitFeedback(true)">Accurate</button>
                <button onclick="submitFeedback(false)">Inaccurate</button>
                <input type="text" id="feedbackComment" placeholder="Add comment">
            </div>
        </div>
    </div>

<script>
let chats = [];
let feedbackStore = JSON.parse(localStorage.getItem('feedback') || '[]');
let currentChat = null;

document.getElementById('csvFile').addEventListener('change', function(e) {
    // Auto-process on file selection
    Papa.parse(e.target.files[0], {
        header: true,
        complete: function(results) {
            processData(results.data);
        }
    });
});

function analyzeChats() {
    if (chats.length === 0) {
        alert('Please upload a CSV file first');
        return;
    }
    updateDashboard();
    renderResults();
}

function processData(rawData) {
    chats = rawData.map(chat => ({
        chatId: chat['Chat Id'],
        agent: chat['Agent Name'],
        email: chat['Email'],
        messages: parseMessages(chat['Messages']),
        redFlags: detectRedFlags(chat['Messages']),
        rebill: detectRebillScript(chat['Messages']),
        tnr: detectTNRScript(chat['Messages'])
    }));

    // Auto-trigger analysis on upload
    analyzeChats();
}

function parseMessages(raw) {
    if (!raw) return [];
    return raw.split('\n').filter(line => line.trim()).map(line => {
        const [timestamp, ...message] = line.trim().split(/ : /);
        return {
            timestamp: new Date(timestamp),
            sender: message[0]?.includes('Customer') ? 'Customer' : 'Agent',
            text: message.slice(1).join(' : ').trim()
        };
    });
}

function detectRedFlags(messages) {
    const flags = [];
    let lastCustomerTime = null;

    // Response time check
    messages.forEach(msg => {
        if (msg.sender === 'Customer') {
            lastCustomerTime = msg.timestamp;
        } else if (msg.sender === 'Agent' && lastCustomerTime) {
            const diff = (msg.timestamp - lastCustomerTime) / 60000;
            if (diff > 5) flags.push("Delayed Response (>5 mins)");
            lastCustomerTime = null;
        }
    });

    // Refund check
    const refundKeywords = ['refund', 'credit', 'money back'];
    const customerRequested = messages.some(m => 
        m.sender === 'Customer' && 
        refundKeywords.some(kw => m.text.toLowerCase().includes(kw))
    );
    
    if (customerRequested && !messages.some(m => 
        m.sender === 'Agent' && m.text.toLowerCase().includes('refund')
    )) {
        flags.push("No Refund Offered");
    }

    return flags;
}

function detectRebillScript(messages) {
    return messages.some(m => 
        m.sender === 'Agent' && 
        m.text.toLowerCase().includes('rebill')
    );
}

function detectTNRScript(messages) {
    return messages.some(m => 
        m.sender === 'Agent' && 
        m.text.toLowerCase().includes('tnr')
    );
}

function updateDashboard() {
    document.getElementById('totalChats').textContent = chats.length;
    const flaggedCount = chats.filter(c => c.redFlags.length > 0).length;
    document.getElementById('redFlagsCount').textContent = flaggedCount;
    
    const rebillCount = chats.filter(c => c.rebill).length;
    document.getElementById('rebillCount').textContent = rebillCount;
    
    const tnrCount = chats.filter(c => c.tnr).length;
    document.getElementById('tnrCount').textContent = tnrCount;
    
    // Update chart
    updateTrendChart();
    
    // Show results section
    document.getElementById('results').style.display = 'block';
}

function renderResults() {
    const container = document.getElementById('flaggedChatsList');
    
    const flaggedChats = chats.filter(c => c.redFlags.length > 0);
    
    if (flaggedChats.length === 0) {
        container.innerHTML = '<p>No red flags detected</p>';
        return;
    }

    container.innerHTML = `
        <table>
            <tr>
                <th>Chat ID</th>
                <th>Agent</th>
                <th>Flags</th>
                <th>Action</th>
            </tr>
            ${flaggedChats.map(chat => `
                <tr>
                    <td>${chat.chatId}</td>
                    <td>${chat.agent}</td>
                    <td>${chat.redFlags.join(', ')}</td>
                    <td>
                        <button onclick="showReview('${chat.chatId}')">Review</button>
                    </td>
                </tr>
            `).join('')}
        </table>
    `;
}

function showReview(chatId) {
    currentChat = chats.find(c => c.chatId === chatId);
    document.getElementById('reviewPanel').classList.remove('hidden');
    
    // Show chat details
    document.getElementById('chatDetails').innerHTML = `
        <p><strong>Chat ID:</strong> ${currentChat.chatId}</p>
        <p><strong>Agent:</strong> ${currentChat.agent}</p>
        <p><strong>Email:</strong> ${currentChat.email}</p>
        <p><strong>Flags:</strong> ${currentChat.redFlags.join(', ')}</p>
    `;
    
    // Show messages
    document.getElementById('messageList').innerHTML = `
        <h4>Messages</h4>
        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px">
            ${currentChat.messages.map(msg => `
                <div class="${msg.sender === 'Agent' ? 'message-agent' : 'message-customer'}" style="margin: 5px 0">
                    <strong>${msg.sender}:</strong> ${msg.text}
                </div>
            `).join('')}
        </div>
    `;
}

function submitFeedback(isAccurate) {
    const comment = document.getElementById('feedbackComment').value;
    saveFeedback(currentChat.chatId, isAccurate, comment);
    alert('Feedback saved!');
}

function saveFeedback(chatId, accurate, comment = '') {
    feedbackStore.push({
        chatId,
        accurate,
        comment,
        timestamp: new Date().toISOString()
    });
    localStorage.setItem('feedback', JSON.stringify(feedbackStore));
}

function updateTrendChart() {
    const ctx = document.getElementById('trendChart').getContext('2d');
    const weeklyData = getWeeklyStats();
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: weeklyData.map(d => d.week),
            datasets: [{
                label: 'Red Flags',
                data: weeklyData.map(d => d.flags),
                borderColor: '#dc3545',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function getWeeklyStats() {
    // Simplified weekly aggregation
    return Array.from({length: 4}, (_, i) => ({
        week: `Week ${i+1}`,
        flags: Math.floor(Math.random() * 50)
    }));
}

// Initial render
document.getElementById('totalChats').textContent = 0;
document.getElementById('results').style.display = 'none';
</script>
</body>
</html>
