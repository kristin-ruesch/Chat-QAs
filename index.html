<!DOCTYPE html>
<html>
<head>
    <title>Chat Quality Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ... existing styles ... */
        .error { color: #dc3545; padding: 10px; margin: 10px 0; border: 1px solid #f5c2c7 }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chat Quality Analyzer</h1>
        
        <input type="file" id="csvFile" accept=".csv" multiple>
        <button onclick="analyzeChats()" class="analyze-btn">Analyze Chats</button>
        
        <div id="errorMessage" class="error hidden"></div>
        
        <!-- ... rest of existing HTML ... -->
    </div>

<script>
let chats = [];
let feedbackStore = JSON.parse(localStorage.getItem('feedback') || '[]');
let currentChat = null;

document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Validate file extension
    if (!file.name.toLowerCase().endsWith('.csv')) {
        showError('Please upload a CSV file');
        return;
    }
    
    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            if (results.errors.length > 0) {
                showError(`CSV Error: ${results.errors[0].message}`);
                return;
            }
            processData(results.data);
        },
        error: function(error) {
            showError(`File read error: ${error.message}`);
        }
    });
});

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
}

function analyzeChats() {
    if (chats.length === 0) {
        showError('Please upload a CSV file first');
        return;
    }
    
    // Clear previous errors
    document.getElementById('errorMessage').classList.add('hidden');
    
    // Process and display results
    updateDashboard();
    renderResults();
}

function processData(rawData) {
    // Map CSV columns to expected names (case-insensitive)
    const columnMap = {
        'Chat Id': ['Chat Id', 'ChatID', 'chat_id'],
        'Agent Name': ['Agent Name', 'Agent', 'agent_name'],
        'Email': ['Email', 'email', 'customer_email'],
        'Messages': ['Messages', 'Transcript', 'message']
    };

    // Normalize column names
    const normalizedData = rawData.map(row => {
        const normalized = {};
        for (const [key, aliases] of Object.entries(columnMap)) {
            const foundKey = Object.keys(row).find(k => 
                aliases.includes(k.trim()) || aliases.includes(k.toLowerCase().trim())
            );
            normalized[key] = foundKey ? row[foundKey] : '';
        }
        return normalized;
    });

    chats = normalizedData.map(chat => ({
        chatId: chat['Chat Id'],
        agent: chat['Agent Name'],
        email: chat['Email'],
        messages: parseMessages(chat['Messages']),
        redFlags: detectRedFlags(chat['Messages']),
        rebill: detectRebillScript(chat['Messages']),
        tnr: detectTNRScript(chat['Messages'])
    }));

    // Auto-trigger analysis
    analyzeChats();
}

// ... rest of existing functions ...
</script>
</body>
</html>
